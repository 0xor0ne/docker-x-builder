# Build Image targetting ARM (32bits)

If not already done, build the Docker image:

```bash
./scripts/docker_build.sh
```

Create a new persistent volume with:

```bash
docker volume create --name arm32
```

Start the container:

```bash
./scripts/docker_run_inter.sh --volume arm32
```

In the Docker container:

```bash
cd workspace/buildroot
# Checkout the desired version of Buildroot, in the example we are going to use
# the lastest stable release (2022.02.1 at the time of writing)
git checkout `git tag --sort=-taggerdate | grep -v rc | head -1`
```

Copy the provided example configuration (based on
`qemu_arm_vexpress_defconfig`):

```bash
cp ~/shared/configs/arm32_example/arm32_example_config .config
make olddefconfig
```

In case you need to, edit the provided configuration:

```bash
make menuconfig
```

In case you need to edit the kernel specific configuration:

```bash
make linux-menuconfig
```

In case you need to edit the Busybox specific configuration:

```bash
make busybox-menuconfig
```

By default the provided configuration uses an overlay located in
`~/shared/configs/arm32_example/overlay` which can be modified based on your
needs.

Note also that with the provided configuration two users are created in the
final imane: `root` (password `root`) and `user` (password `user`).

When you are happy with the configuration, start the build process (this is
going to take a while):

```bash
make
```

At the end of the build process, the final artifacts are placed in
`output/images/`. You can copy these in the shared directory:

```bash
cp -r output/images ~/shared/workspace
```

in this way you will find the final articats on the host in directory
`workspace/images`.

## QEMU Emulation Example

You can also emulate the newly created image with:

```bash
~/shared/configs/arm32_example/start_qemu.sh
```

Then, attach to the container from another terminal:

```bash
./scripts/docker_attach.sh
```

and use SSH to log into the emulated environment:

```bash
ssh -i ~/shared/data/ssh/br_id_rsa0 user@192.168.0.2
```

## Toolchain SDK

You may use the toolchain that was used by Buildroot to compile, for your
target, your own programs or other software that are not packaged in Buildroot
itself.

The toolchain generated by Buildroot is located by default in `output/host/`.
You can ask Buildroot to create a toolchain package with:

```bash
make sdk
```

This generates a tarball named `<TARGET-TUPLE>_sdk-buildroot.tar.gz` in
`output/images`.

In order to use the `SDK` you must extract the tarball and run the script
`relocate-sdk.sh` located inside the extracted directory (this script must be
executed only one time after the tarball extraction).

Then, when you need to use the toolchain you can source the file
`environment-setup` located inside the extracted toolchain directory. This
script exports a number of environment variables that will help cross-compile
your projects using the Buildroot SDK (note that this file only exists because
in the provided example configuration we enabled option
BR2_PACKAGE_HOST_ENVIRONMENT_SETUP).

At this point it is possible to cross-compile code for the Buildroot target like
in the simple example reported below:

```bash
cat > /tmp/test.c <<EOF
#include <stdio.h>

int main()
{
  printf("Hello!\n");
  return 0;
}
EOF
```

```bash
arm-linux-gcc -g -o /tmp/test /tmp/test.c
```

```bash
>>> file /tmp/test
/tmp/test: ELF 32-bit LSB pie executable, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux-armhf.so.3, for GNU/Linux 4.9.0, with debug_info, not stripped
```

## Process Debug Example

Run the emulator as shown in section [QEMU Emulation Example](#qemu-emulation-example).

In a different terminal, attach to the running container:

```bash
./scripts/docker_attach.sh
```

and build an executable to debug (see section [Toolchain SDK](#toolchain-sdk)
for an example).

Copy the executable on the emulated device:

```bash
scp -i ~/shared/data/ssh/br_id_rsa0 </path/to/executable/to/debug> user@192.168.0.2:/tmp/
```

On the first terminal, where you have the shell of the emulated device, login as
user `user` (password `user`) and run:

```bash
cd /tmp
gdbserver :1234 <name_of_your_executable>
```

On the other shell:

```bash
~/workspace/buildroot/output/host/bin/arm-linux-gdb
(gdb) file </path/to/executable/to/debug>
(gdb) target remote 192.168.0.2:1234
...
# Debug with standard GDB commands
```
